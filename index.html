<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>2048</title>
    <style>
        body{
            overflow: hidden;
	    background-color: lightgray;
        }
        #board{
            position: relative;
            left: 35%;
            transform: translateX(-21%);
        }
        .cell{
           position: absolute;
            background-color: grey;
            border: 1vw solid gray;
        }
        .inner{
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%,-50%);
            font-size: 3.2vw;
            font-weight: bold;
        }
        #control{
            text-align: center;
            position: absolute;
            left: 85%;
            transform: translate(-80%,-125%);
        }
        .btn{
            height: 5vw;
            width: 5vw;
            margin-bottom: 2vw;
            border-radius: 50%;
        }
        #notice{
            position: absolute;
            text-align: center;
            top: 50%;
            left: 50%;
            height: 15vh;
            width: 30vw;
            background-color: #763A7A;
            opacity: 0.9;
            color: white;
            transform: translate(-50%,-50%);
            visibility: hidden;
        }
        #reset{
            position: relative;
            left: 50%;
            transform: translateX(-50%);
            height: 3vw;
            width: 15vw;
            margin-bottom: 2vw;
        }
        #score{
            position: absolute;
            right: 15%;
        }
        #font,#score,#reset,.btn{
            font-size: 2vw;
            font-weight: bold;
        }
    </style>
</head>
<body>

<button id="reset" onclick="board.reset()">Reset</button>
<div id="score"></div>
<div id="board"></div>
<div id="control">
    <button class="btn" onclick="board.forwardAction(-1,0)">U</button><br/>
    <button class="btn" onclick="board.forwardAction(0,-1)" style="transform: translateX(-100%)">L</button>
    <button class="btn" onclick="board.reverseAction(0,1)" style="transform: translateX(100%)">R</button><br/>
    <button class="btn" onclick="board.reverseAction(1,0)">D</button>
</div>
<div id="notice">
    <div class="inner">You Loose</div>
</div>
<script>
    class Cell{
        constructor(i,j,size){
            this.resetValue = 0;
            this.value = this.resetValue;
            this.fused = false;
            this.target = this.createCell(i,j,size);
        }

        createCell(i,j,size){
            let cell = document.createElement("div");
            cell.style.height = size+"vw";
            cell.style.width = size+"vw";
            cell.style.top = (i*size)+"vw";
            cell.style.left = (j*size)+"vw";
            cell.classList.add("cell");
            let inner = document.createElement("div");
            inner.classList.add("inner");
            inner.innerText = this.resetValue;
            cell.appendChild(inner);
            document.getElementById("board").appendChild(cell);
            return cell;
        }
    }

    class Board{
        constructor(row,col,size,colors,maxScore){
            this.row = row;
            this.col = col;
            this.size = size;
            this.colors = colors;
            this.gameOver = false;
            this.maxScore = maxScore;
            this.board = this.createBoard();
            document.getElementById("control").style.top = (size*(row+0.5))+"vw";
            this.reset();
        }

        createBoard(){
            let board = new Array(this.row);
            for(let i=0;i<this.row;i++){
                board[i] = new Array(this.col);
                for(let j=0;j<this.col;j++)
                    board[i][j] = new Cell(i,j,this.size);
            }
            return board;
        }

        pushRandomValue(){
            let emptySpace = [];
            for(let i=0;i<this.row;i++)
                for(let j=0;j<this.col;j++)
                    if(this.board[i][j].value==0)
                        emptySpace.push(this.board[i][j]);
            if(emptySpace.length==0)
                return;
            let newVal = Math.random()>0.1?2:4;
            let index = Math.floor(Math.random()*emptySpace.length);
            emptySpace[index].value = newVal;
            this.update();
        }

        update(){
            for(let i=0;i<this.row;i++)
                for(let j=0;j<this.col;j++) {
                    this.board[i][j].target.children[0].innerText = this.board[i][j].value!=this.board[i][j].resetValue?this.board[i][j].value:"";
                    this.board[i][j].target.style.backgroundColor = this.colors[this.board[i][j].value];
                    this.board[i][j].fused = false;
                    if(this.board[i][j].value==this.maxScore){
                        this.gameOver = true;
                        this.showNotice("You Won!");
                    }
                }
            document.getElementById("score").innerText = "Score : "+this.totalScore;
        }

        adjust(i,j,bi,bj,ai,aj){
            if(i<0 || j<0 || i>=this.row || j>=this.col || this.board[i][j].fused || this.board[bi][bj].value == this.board[bi][bj].resetValue || (this.board[i][j].value!=this.board[bi][bj].value && this.board[i][j].value!=this.board[i][j].resetValue))
                return true;
            if(this.board[i][j].value == this.board[bi][bj].value){
                this.board[i][j].value+=this.board[bi][bj].value;
                this.totalScore+=this.board[i][j].value;
                this.board[bi][bj].value = this.board[bi][bj].resetValue;
                this.board[i][j].fused = true;
            }
            else if(this.adjust(i+ai,j+aj,bi,bj,ai,aj)){
                this.board[i][j].value = this.board[bi][bj].value;
                this.board[bi][bj].value = this.board[bi][bj].resetValue;
            }
            return false;
        }

        reverseAction(ai,aj){
            if(this.gameOver)
                return;
            for(let i=this.row-1;i>=0;i--)
                for(let j=this.col-1;j>=0;j--)
                    this.adjust(i+ai, j+aj, i, j, ai, aj);
            if(!this.isOver())
                this.pushRandomValue();
        }

        forwardAction(ai,aj){
            if(this.gameOver)
                return;
            for(let i=0;i<this.row;i++)
                for(let j=0;j<this.col;j++)
                    this.adjust(i+ai, j+aj, i, j, ai, aj);
            if(!this.isOver())
                this.pushRandomValue();
        }

        isOver(){
            for(let i=0;i<this.row;i++)
                for(let j=0;j<this.col;j++)
                    if(this.board[i][j].value==this.board[i][j].resetValue || this.hasPossible(i,j,this.board[i][j].value,0)==true)
                        return false;
            this.gameOver = true;
            this.showNotice("Game Over!");
            return true;
        }

        hasPossible(i,j,value,level){
            if(i<0 || j<0 || i>=this.row || j>=this.row)
                return -1;
            if(level==1)
                return this.board[i][j].value;
            if(this.hasPossible(i+1,j,value,level+1)==value || this.hasPossible(i-1,j,value,level+1)==value || this.hasPossible(i,j+1,value,level+1)==value || this.hasPossible(i,j-1,value,level+1)==value)
                return true;
            return false;
        }

        showNotice(message){
            let notice = document.getElementById("notice");
            notice.children[0].innerText = message;
            notice.style.visibility = "visible";
        }

        reset(){
	    this.totalScore = 0;
            document.getElementById("notice").style.visibility = "hidden";
            for(let i=0;i<this.row;i++)
                for(let j=0;j<this.col;j++)
                    this.board[i][j].value = this.board[i][j].resetValue;
            this.pushRandomValue();
            this.pushRandomValue();
            this.update();
        }
    }

    let colors = {0:"darkgray",2:"rgb(238, 228, 218)",4:"rgb(237, 224, 200)",8:"rgb(242, 177, 121)",16:"rgb(245, 149, 99)",32:"rgb(246, 124, 95)",64:"rgb(246, 94, 59)",128:"rgb(237, 207, 114)",
        256:"#FFF056",512:"#99CD4E",1024:"#F1684E",2048:"#E25D33"};
    let board = new Board(4,4,12,colors,2048);
</script>
</body>
</html>
